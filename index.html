<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£®ä¹‹å‘¼å¸ å¤©æ°£è‹±é›„ç«™ ğŸŒ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Noto+Sans+TC:wght@700;900&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --comic-green-dark: #2D5A27;
            --comic-green-bright: #7CFF6B;
            --comic-green-soft: #C8E6C9;
            --paper-white: #F1F8E9;
            --ink-black: #1B2E1A;
            --comic-border: 4px solid var(--ink-black);
            --comic-shadow: 6px 6px 0 var(--comic-green-dark);
        }

        body {
            font-family: 'Bungee Inline', 'Noto Sans TC', sans-serif;
            background-color: var(--paper-white);
            background-image: radial-gradient(var(--comic-green-dark) 10%, transparent 10%), radial-gradient(var(--comic-green-dark) 10%, transparent 10%);
            background-size: 25px 25px;
            background-position: 0 0, 12.5px 12.5px;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .weather-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--comic-green-bright);
            padding: 30px;
            border: var(--comic-border);
            border-radius: 20px;
            box-shadow: var(--comic-shadow);
            text-align: center;
        }

        .current-forecast {
            background-color: white;
            padding: 20px;
            border: var(--comic-border);
            border-radius: 15px;
            box-shadow: 5px 5px 0 var(--ink-black);
            margin-bottom: 25px;
        }

        .temperature {
            font-size: 5em;
            font-weight: 900;
            color: var(--comic-green-dark);
            text-shadow: 3px 3px 0 var(--comic-green-soft);
        }

        /* åœ–è¡¨å°ˆç”¨å€å¡Š */
        .chart-section {
            background: white;
            border: var(--comic-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 4px 4px 0 var(--ink-black);
        }

        .future-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .future-card {
            background: var(--comic-green-soft);
            padding: 15px;
            border: var(--comic-border);
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div id="app" class="weather-container">
        <h1 style="font-size: 3em; -webkit-text-stroke: 1px var(--ink-black);">BAM! æ°£æº«è§€æ¸¬! ğŸŒ¿</h1>

        <div v-if="loading">è‹±é›„æ­£åœ¨è§€æ¸¬æ•¸æ“šä¸­...</div>

        <div v-else>
            <div class="current-forecast">
                <div style="font-size: 1.5em; font-weight: 900;">{{ cityName }} | ç›®å‰å¤©æ°£</div>
                <div class="temperature">{{ mainForecast.maxTemp }}Â°C</div>
                <div style="font-size: 1.2em; font-weight: 900;">{{ mainForecast.weather }}</div>
            </div>

            <div class="chart-section">
                <h3 style="margin-top:0; color: var(--comic-green-dark);">24å°æ™‚æ°£æº«è¶¨å‹¢</h3>
                <canvas id="tempChart"></canvas>
            </div>

            <div class="future-grid">
                <div v-for="f in futureForecasts" :key="f.startTime" class="future-card">
                    <div style="font-weight: 900;">{{ getShortTime(f.startTime) }}</div>
                    <div style="font-size: 2.5em;">{{ getWeatherEmoji(f.weather) }}</div>
                    <div style="font-weight: 900;">{{ f.minTemp }}~{{ f.maxTemp }}Â°C</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const cityName = ref('');
                const mainForecast = ref(null);
                const futureForecasts = ref([]);
                const loading = ref(true);

                const getWeatherEmoji = (text) => {
                    if (text.includes('æ™´')) return 'â˜€ï¸';
                    if (text.includes('é›²')) return 'â˜ï¸';
                    if (text.includes('é›¨')) return 'ğŸŒ§ï¸';
                    return 'ğŸƒ';
                };

                const getShortTime = (timeStr) => new Date(timeStr).getHours() + ":00";

                // åˆå§‹åŒ– Chart.js åœ–è¡¨
                const initChart = (data) => {
                    const ctx = document.getElementById('tempChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(f => getShortTime(f.startTime)),
                            datasets: [{
                                label: 'æ°£æº« (Â°C)',
                                data: data.map(f => f.maxTemp),
                                borderColor: '#2D5A27',
                                backgroundColor: 'rgba(124, 255, 107, 0.3)',
                                borderWidth: 5,
                                pointBackgroundColor: '#E91E63', // äº®ç²‰è‰²é»å¢åŠ å°æ¯”
                                fill: true,
                                tension: 0.4 // è®“æ›²ç·šå¹³æ»‘
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: false, grid: { color: '#eee' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                };

                const fetchData = async () => {
                    try {
                        const res = await fetch('https://nutc-web-vic-peng.zeabur.app/api/weather/kaohsiung');
                        const json = await res.json();
                        cityName.value = json.data.city;
                        mainForecast.value = json.data.forecasts[0];
                        futureForecasts.value = json.data.forecasts;
                        loading.value = false;

                        // é—œéµï¼šå¿…é ˆç­‰å¾… Vue æ¸²æŸ“å®Œ DOM å¾Œæ‰èƒ½æŠ“å–ç•«å¸ƒ
                        await nextTick();
                        initChart(json.data.forecasts);
                    } catch (e) {
                        console.error("Fetch Error");
                        loading.value = false;
                    }
                };

                onMounted(fetchData);
                return { cityName, mainForecast, futureForecasts, loading, getWeatherEmoji, getShortTime };
            }
        }).mount('#app');
    </script>
</body>

</html>