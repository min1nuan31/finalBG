<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§©Ê∞£È†êÂ†±Á´ô üåø</title>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Noto+Sans+TC:wght@700;900&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --comic-green-dark: #2D5A27;
            --comic-green-bright: #7CFF6B;
            --comic-green-soft: #C8E6C9;
            --paper-white: #F1F8E9;
            --ink-black: #1B2E1A;
            --comic-border: 4px solid var(--ink-black);
            --comic-shadow: 6px 6px 0 var(--comic-green-dark);
        }

        body {
            font-family: 'Bungee Inline', 'Noto Sans TC', sans-serif;
            background-color: var(--paper-white);
            background-image: radial-gradient(var(--comic-green-dark) 10%, transparent 10%), radial-gradient(var(--comic-green-dark) 10%, transparent 10%);
            background-size: 25px 25px;
            background-position: 0 0, 12.5px 12.5px;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .weather-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--comic-green-bright);
            padding: 30px;
            border: var(--comic-border);
            border-radius: 20px;
            box-shadow: var(--comic-shadow);
            transform: rotate(-0.5deg);
        }

        .current-forecast {
            background: white;
            border: var(--comic-border);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 6px 6px 0 var(--ink-black);
            margin-bottom: 25px;
            text-align: center;
        }

        .main-temp {
            font-size: 4.5rem;
            font-weight: 900;
            color: var(--comic-green-dark);
            line-height: 1;
        }

        .weather-icon {
            font-size: 5rem;
            animation: float 3s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* ÂúñË°®ÂçÄÂ°ä */
        .chart-box {
            background: white;
            border: var(--comic-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 4px 4px 0 var(--ink-black);
            height: 250px;
        }

        .export-btn {
            background: var(--ink-black);
            color: var(--comic-green-bright);
            border: var(--comic-border);
            padding: 12px;
            width: 100%;
            font-size: 1.2rem;
            font-weight: 900;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .export-btn:hover {
            background: #E91E63;
            color: white;
        }

        .future-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .future-card {
            background: var(--comic-green-soft);
            border: var(--comic-border);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app" class="weather-container">
        <h1 style="text-align:center; font-size:2.5rem; -webkit-text-stroke:1px var(--ink-black);">Â§©Ê∞£È†êÂ†± üåø</h1>

        <div v-if="loading" style="text-align:center;">ÊéÉÊèè‰∏≠...</div>

        <div v-else>
            <div style="text-align:center; font-weight:900; margin-bottom:10px;">{{ cityName }}Â§©Ê∞£ÁãÄÊ≥Å</div>

            <div class="current-forecast">
                <div style="background:var(--ink-black); color:white; display:inline-block; padding:2px 10px;">{{
                    getPeriod(mainForecast.startTime) }}</div>
                <div class="weather-icon">{{ getEmoji(mainForecast.weather) }}</div>
                <div class="main-temp">{{ mainForecast.maxTemp }}</div>
                <div style="font-weight:900;">{{ mainForecast.weather }} | ÈôçÈõ® {{ mainForecast.rain }}</div>
                <div style="font-size:0.8rem; margin-top:5px;">{{ mainForecast.comfort }}</div>
            </div>

            <div class="chart-box">
                <canvas id="tempChart"></canvas>
            </div>

            <button class="export-btn" @click="exportCSV">‰∏ãËºâÂ§©Ê∞£Â†±Âëä üíæ</button>

            <div class="future-grid">
                <div v-for="f in futureForecasts" class="future-card">
                    <div style="font-weight:900; font-size:0.8rem;">{{ getPeriod(f.startTime).split(' ')[1] }}</div>
                    <div style="font-size:2rem;">{{ getEmoji(f.weather) }}</div>
                    <div style="font-weight:900;">{{ f.minTemp }}~{{ f.maxTemp }}</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const cityName = ref('');
                const mainForecast = ref(null);
                const futureForecasts = ref([]);
                const loading = ref(true);

                const getEmoji = (t) => t.includes('Êô¥') ? '‚òÄÔ∏è' : (t.includes('Èõ®') ? 'üåßÔ∏è' : '‚òÅÔ∏è');
                const getPeriod = (t) => {
                    const h = new Date(t).getHours();
                    if (h < 12) return 'POW! Êó©Êô®';
                    if (h < 18) return 'WHAM! ‰∏ãÂçà';
                    return 'Zzz... Êôö‰∏ä';
                };

                // CSV ÂåØÂá∫ÈÇèËºØ (Âä†ÂàÜÈ†Ö)
                const exportCSV = () => {
                    let csv = "\uFEFFÊôÇÊÆµ,ÊúÄÈ´òÊ∫´,Â§©Ê∞£\n";
                    [mainForecast.value, ...futureForecasts.value].forEach(f => {
                        csv += `${getPeriod(f.startTime)},${f.maxTemp},${f.weather}\n`;
                    });
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'weather.csv';
                    a.click();
                };

                // ÂúñË°®ÈÇèËºØ (Âä†ÂàÜÈ†Ö)
                const initChart = (data) => {
                    const ctx = document.getElementById('tempChart');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(f => getPeriod(f.startTime).split(' ')[1]),
                            datasets: [{
                                label: 'Ê∞£Ê∫´',
                                data: data.map(f => parseInt(f.maxTemp)),
                                borderColor: '#2D5A27',
                                backgroundColor: 'rgba(124, 255, 107, 0.4)',
                                fill: true,
                                borderWidth: 4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                };

                const loadData = async () => {
                    const res = await fetch('https://nutc-web-vic-peng.zeabur.app/api/weather/kaohsiung');
                    const json = await res.json();
                    cityName.value = json.data.city;
                    mainForecast.value = json.data.forecasts[0];
                    futureForecasts.value = json.data.forecasts.slice(1);
                    loading.value = false;
                    await nextTick();
                    initChart(json.data.forecasts);
                };

                onMounted(loadData);
                return { cityName, mainForecast, futureForecasts, loading, getEmoji, getPeriod, exportCSV };
            }
        }).mount('#app');
    </script>
</body>

</html>